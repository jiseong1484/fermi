<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agent Console</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; padding: 16px; max-width: 960px; margin: 0 auto; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 12px 0; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    .hint { color: #555; font-size: 14px; }
    video { width: 100%; max-height: 320px; background: #000; border-radius: 12px; }
    pre { background: #f6f6f6; padding: 10px; border-radius: 10px; overflow: auto; }
  </style>
</head>
<body>
<h1>상담사 콘솔 (Agent)</h1>

<div class="card">
  <div class="row">
    <button id="btnCreateSession">세션 생성</button>
    <button id="btnCopyCustomerUrl" disabled>고객 링크 복사</button>
  </div>
  <div class="row" style="margin-top:10px;">
    <div style="flex:1; min-width: 220px;">
      <label>agentId</label>
      <input id="agentId" placeholder="예: agent-1" value="agent-1" />
    </div>
    <div style="flex:1; min-width: 220px;">
      <label>customerId (임시)</label>
      <input id="customerId" placeholder="예: customer-1" value="customer-1" />
    </div>
  </div>
  <p class="hint">세션 생성 후 고객에게 링크를 보내세요.</p>
  <div class="row" style="flex:1">
    <div style="flex:1; min-width: 320px;">
      <label>sessionId (roomId)</label>
      <input id="sessionId" placeholder="세션 생성하면 자동으로 채워집니다" readonly />
    </div>
    <div style="flex:2; min-width: 320px;">
      <label>고객 링크</label>
      <input id="customerUrl" placeholder="세션 생성하면 자동으로 채워집니다" readonly />
    </div>
  </div>
  <div class="hint" id="sessionStatus"></div>
</div>

<div class="card">
  <h3>연결</h3>
  <div class="row">
    <button id="btnStartMedia" disabled>카메라/마이크 켜기</button>
    <button id="btnCreatePC" disabled>PC 만들기</button>
    <button id="btnConnectWS" disabled>WS 연결</button>
    <button id="btnStartCall" disabled>통화 시작(Offer)</button>
  </div>
  <div class="row">
    <div style="flex:1; min-width: 320px;">
      <div class="hint" id="wsStatus">WS: -</div>
      <div class="hint" id="pcStatus">PC: -</div>
      <div class="hint" id="iceStatus">ICE: -</div>
    </div>
    <div style="flex:1; min-width: 320px;">
      <pre id="log"></pre>
    </div>
  </div>
</div>

<div class="card">
  <h3>영상</h3>
  <div class="row">
    <div style="flex:1; min-width: 320px;">
      <div class="hint">Local</div>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div style="flex:1; min-width: 320px;">
      <div class="hint">Remote</div>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  // ===== State =====
  let roomId = "";            // Phase3에서는 roomId = sessionId
  let ws = null;
  let pc = null;
  let localStream = null;

  let pendingRemoteCandidates = [];

  function uiLog(...args) {
    console.log(...args);
    const el = $("log");
    el.textContent += args.map(a => (typeof a === "string" ? a : JSON.stringify(a))).join(" ") + "\n";
    el.scrollTop = el.scrollHeight;
  }

  function setText(id, msg) {
    const el = $(id);
    if (!el) return;
    el.textContent = msg;
  }

  function wsSend(type, payload) {
    const msg = { type, roomId, payload };
    uiLog("[WS ->]", type, "room=", roomId);
    if (!ws || ws.readyState !== 1) {
      uiLog("[WS] send skipped; ws not open", ws?.readyState);
      return;
    }
    ws.send(JSON.stringify(msg));
  }

  async function flushPendingCandidates() {
    if (!pc || !pc.remoteDescription) return;
    const toAdd = pendingRemoteCandidates;
    pendingRemoteCandidates = [];
    for (const c of toAdd) {
      try { await pc.addIceCandidate(c); }
      catch (e) { console.error("addIceCandidate failed (flush)", e, c); }
    }
  }

  function getWsUrl() {
    const proto = location.protocol === "https:" ? "wss" : "ws";
    // same-origin (ngrok https -> wss, local http -> ws)
    return `${proto}://${location.host}/ws`;
  }

  function getApiBase() {
    // same-origin (ngrok https, local http)
    return location.origin;
  }

  function getCustomerJoinUrl(sessionId) {
    // 현재 페이지의 origin(호스트/포트)을 기준으로 고객용 링크 생성
    return `${location.origin}/join.html?sessionId=${encodeURIComponent(sessionId)}`;
  }

  // ===== Phase3: create session =====
  $("btnCreateSession").onclick = async () => {
    try {
      const agentId = $("agentId").value.trim();
      const customerId = $("customerId").value.trim();
      if (!agentId) { alert("agentId를 입력하세요"); return; }
      if (!customerId) { alert("customerId를 입력하세요(Phase4에서는 매칭에서 자동으로 채워질 예정)"); return; }

      setText("sessionStatus", "세션 생성 중...");

      const res = await fetch(`${getApiBase()}/api/sessions`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ agentId, customerId })
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`create session failed: ${res.status} ${text}`);
      }

      const data = await res.json();

      roomId = data.sessionId;
      $("sessionId").value = data.sessionId;

      // 서버가 customerUrl을 내려주면 그걸 우선 사용 (Render/배포 환경에서 정확)
      $("customerUrl").value = data.customerUrl || getCustomerJoinUrl(data.sessionId);
      $("btnCopyCustomerUrl").disabled = false;

      setText("sessionStatus", `세션 생성 완료. 만료: ${data.expiresAt}`);
      $("btnStartMedia").disabled = false;
    } catch (e) {
      console.error(e);
      setText("sessionStatus", "세션 생성 실패: " + e.message);
    }
  };

  $("btnCopyCustomerUrl").onclick = async () => {
    try {
      await navigator.clipboard.writeText($("customerUrl").value);
      setText("sessionStatus", "고객 링크 복사 완료!");
    } catch {
      setText("sessionStatus", "복사 실패(브라우저 권한). 링크를 직접 선택해서 복사해줘.");
    }
  };

  // ===== Media =====
  $("btnStartMedia").onclick = async () => {
    if (!roomId) { alert("먼저 세션을 생성하세요."); return; }

    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    $("localVideo").srcObject = localStream;

    $("btnCreatePC").disabled = false;
    uiLog("[MEDIA] local stream ready");
  };

  // ===== PC =====
  $("btnCreatePC").onclick = async () => {
    if (!localStream) { alert("먼저 카메라/마이크 켜기"); return; }
    if (pc) { alert("이미 PC가 있습니다."); return; }

    pc = new RTCPeerConnection({ iceServers: [] });

    for (const track of localStream.getTracks()) pc.addTrack(track, localStream);

    pc.ontrack = (event) => {
      $("remoteVideo").srcObject = event.streams[0];
      uiLog("[PC] ontrack remote stream");
    };

    pc.onicecandidate = (event) => {
      if (event.candidate) {
        uiLog("[ICE local] generated", event.candidate.candidate);
        if (ws && ws.readyState === 1 && roomId) wsSend("candidate", event.candidate);
      } else {
        setText("iceStatus", "ICE 후보 수집 완료");
      }
    };

    pc.onconnectionstatechange = () => setText("pcStatus", `PC: ${pc.connectionState}`);
    pc.oniceconnectionstatechange = () => setText("iceStatus", `ICE: ${pc.iceConnectionState}`);

    setText("pcStatus", "PC: created");
    $("btnConnectWS").disabled = false;
  };

  // ===== WS =====
  $("btnConnectWS").onclick = async () => {
    if (!roomId) { alert("먼저 세션 생성"); return; }
    if (!pc) { alert("먼저 PC 만들기"); return; }

    ws = new WebSocket(getWsUrl());
    uiLog("[WS] connecting to", ws.url);

    ws.onopen = () => {
      setText("wsStatus", "WS: connected");
      uiLog("[WS] open");
      wsSend("join", {});
      $("btnStartCall").disabled = false;
    };

    ws.onclose = () => {
      setText("wsStatus", "WS: closed");
      uiLog("[WS] close");
    };

    ws.onerror = () => {
      setText("wsStatus", "WS: error");
      uiLog("[WS] error");
    };

    ws.onmessage = async (evt) => {
      let msg;
      try { msg = JSON.parse(evt.data); }
      catch (e) { console.error("JSON parse failed", e, evt.data); return; }

      uiLog("[WS <-]", msg.type, "room=", msg.roomId);

      if (msg.type === "offer") {
        await pc.setRemoteDescription(msg.payload);
        await flushPendingCandidates();

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        wsSend("answer", pc.localDescription);

      } else if (msg.type === "answer") {
        await pc.setRemoteDescription(msg.payload);
        await flushPendingCandidates();

      } else if (msg.type === "candidate") {
        if (pc.remoteDescription) await pc.addIceCandidate(msg.payload);
        else pendingRemoteCandidates.push(msg.payload);
      }
    };
  };

  // ===== Call (Agent initiates) =====
  $("btnStartCall").onclick = async () => {
    if (!pc) { alert("먼저 PC 만들기"); return; }
    if (!ws || ws.readyState !== 1) { alert("먼저 WS 연결"); return; }

    uiLog("[CALL] start clicked. room=", roomId);

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    wsSend("offer", pc.localDescription);
  };
</script>
</body>
</html>