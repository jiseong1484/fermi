<!-- 테스트용 화면 -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phase1 - WebRTC P2P (Manual Signaling)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    video { width: 360px; max-width: 100%; background: #111; border-radius: 12px; }
    textarea { width: 100%; height: 140px; }
    button { padding: 10px 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin-top: 12px; }
    .hint { color: #555; font-size: 14px; }
  </style>
</head>
<body>
  <h2>Phase 1: WebRTC 1:1 (서버 없이 수동 연결)</h2>
  <p class="hint">
    같은 파일을 <b>브라우저 탭 2개</b>에서 열고, A 탭에서 Offer를 만들고 B 탭에서 Answer를 만든 뒤,
    ICE 후보도 서로 교환하면 연결됩니다.
  </p>

  <div class="row">
    <div>
      <h3>내 영상(Local)</h3>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div>
      <h3>상대 영상(Remote)</h3>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>

  <div class="card">
    <h3>0) Room / Signaling (Phase2)</h3>
    <input id="roomId" placeholder="roomId (예: test)" />
    <button id="btnConnectWS">WS 연결</button>
    <button id="btnStartCall">통화 시작(Offer 생성)</button>
    <div class="hint" id="wsStatus"></div>
  </div>

  <div class="card">
    <h3>1) 미디어 시작</h3>
    <button id="btnStart">카메라/마이크 켜기</button>
    <span id="mediaStatus" class="hint"></span>
  </div>

  <div class="card">
    <h3>2) PeerConnection 생성</h3>
    <button id="btnCreatePC">PC 만들기</button>
    <div class="hint" id="pcStatus"></div>
  </div>

  <div class="card">
    <h3>3-A) (A 탭) Offer 생성 → 아래에 복사</h3>
    <button id="btnCreateOffer">Offer 만들기</button>
    <textarea id="localDesc" placeholder="여기에 내 Offer/Answer(SDP)가 생성됩니다"></textarea>
  </div>

  <div class="card">
    <h3>3-B) (B 탭) A의 Offer 붙여넣기 → Remote 설정</h3>
    <textarea id="remoteDesc" placeholder="상대 SDP(Offer 또는 Answer)를 여기에 붙여넣고 적용"></textarea>
    <button id="btnSetRemoteDesc">Remote SDP 적용</button>
    <button id="btnCreateAnswer">Answer 만들기 (Offer 적용 후)</button>
  </div>

  <div class="card">
    <h3>4) ICE Candidate 교환</h3>
    <p class="hint">
      아래는 연결 후보(ICE)입니다. A↔B 탭에서 서로 복사/붙여넣고 추가하세요.
      (처음엔 후보가 계속 늘어나므로, 어느 정도 모이면 한 번씩 교환해도 됩니다)
    </p>

    <h4>내 ICE candidates (복사해서 상대 탭에 붙여넣기)</h4>
    <textarea id="localCandidates" placeholder="내 ICE 후보가 여기 쌓입니다"></textarea>

    <h4>상대 ICE candidates (여기에 붙여넣고 추가)</h4>
    <textarea id="remoteCandidates" placeholder="상대 ICE 후보(JSON 배열 또는 줄 단위)를 붙여넣으세요"></textarea>
    <button id="btnAddCandidates">상대 ICE 후보 추가</button>

    <div class="hint" id="iceStatus"></div>
  </div>

  <script>
    // --------- Global state ----------
    let localStream = null;
    let pc = null;

    let ws = null;
    let roomId = null;
    let pendingRemoteCandidates = [];

    const $ = (id) => document.getElementById(id);

    function logStatus(el, msg) {
      if (!el) return;
      el.textContent = msg;
    }

    function wsSend(type, payload) {
      const msg = { type, roomId, payload };
      console.log("[WS ->]", type, "room=", roomId, msg);
      if (!ws || ws.readyState !== 1) {
        console.warn("[WS] send skipped; ws not open", ws?.readyState);
        return;
      }
      ws.send(JSON.stringify(msg));
    }

    async function flushPendingCandidates() {
      if (!pc || !pc.remoteDescription) return;
      const toAdd = pendingRemoteCandidates;
      pendingRemoteCandidates = [];
      for (const c of toAdd) {
        try {
          await pc.addIceCandidate(c);
        } catch (e) {
          console.error("addIceCandidate failed (flush)", e, c);
        }
      }
    }

    // --------- 1) Media ----------
    $("btnStart").onclick = async () => {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        $("localVideo").srcObject = localStream;
        logStatus($("mediaStatus"), "미디어 OK (카메라/마이크 스트림 획득)");
      } catch (e) {
        console.error(e);
        logStatus($("mediaStatus"), "미디어 실패: 브라우저 권한/HTTPS 여부 확인");
      }
    };

    // --------- 2) PeerConnection ----------
    $("btnCreatePC").onclick = async () => {
      if (!localStream) {
        alert("먼저 '카메라/마이크 켜기'를 눌러주세요.");
        return;
      }
      if (pc) {
        alert("이미 PC가 있습니다.");
        return;
      }

      // Phase1에서는 STUN/TURN 없이도 같은 네트워크/로컬 환경에서 되는지부터 확인
      pc = new RTCPeerConnection({
        iceServers: [] // Phase5에서 TURN 붙일 거라, 지금은 비워두자
      });

      // 로컬 트랙 추가
      for (const track of localStream.getTracks()) {
        pc.addTrack(track, localStream);
      }

      // 원격 트랙 수신
      pc.ontrack = (event) => {
        $("remoteVideo").srcObject = event.streams[0];
      };

      // ICE candidate 발생 시 textarea에 누적
    
      pc.onicecandidate = (event) => {
        if(event.candidate){
            console.log("[ICE local] candidate generated", event.candidate.type, event.candidate.candidate);
            if (ws && ws.readyState == 1 && roomId){
                console.log("[ICE local] sending candidate to peer");
                wsSend("candidate", event.candidate);
            }
        } else {
            logStatus($("iceStatus"), "ICE 후보 수집 완료");
        }
      };

      // 상태 변화 로그 (디버깅 핵심)
      pc.onconnectionstatechange = () => {
        logStatus($("pcStatus"), `connectionState: ${pc.connectionState}`);
      };
      pc.oniceconnectionstatechange = () => {
        logStatus($("iceStatus"), `iceConnectionState: ${pc.iceConnectionState}`);
      };

      logStatus($("pcStatus"), "PeerConnection 생성 완료");
    };

    // --------- 3) Offer/Answer ----------
    $("btnCreateOffer").onclick = async () => {
      if (!pc) {
        alert("먼저 'PC 만들기'를 눌러주세요.");
        return;
      }
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      $("localDesc").value = JSON.stringify(pc.localDescription, null, 2);
    };

    $("btnSetRemoteDesc").onclick = async () => {
      if (!pc) {
        alert("먼저 'PC 만들기'를 눌러주세요.");
        return;
      }
      try {
        const obj = JSON.parse($("remoteDesc").value);
        await pc.setRemoteDescription(obj);
        alert("Remote SDP 적용 완료");
      } catch (e) {
        console.error(e);
        alert("Remote SDP 파싱/적용 실패: JSON 형식 확인");
      }
    };

    $("btnCreateAnswer").onclick = async () => {
      if (!pc) {
        alert("먼저 'PC 만들기'를 눌러주세요.");
        return;
      }
      if (!pc.remoteDescription) {
        alert("먼저 상대 Offer를 Remote SDP로 적용해야 합니다.");
        return;
      }
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      $("localDesc").value = JSON.stringify(pc.localDescription, null, 2);
    };

    // --------- 4) ICE candidates add ----------
    $("btnAddCandidates").onclick = async () => {
      if (!pc) {
        alert("먼저 'PC 만들기'를 눌러주세요.");
        return;
      }
      const raw = $("remoteCandidates").value.trim();
      if (!raw) {
        alert("상대 ICE 후보를 붙여넣어주세요.");
        return;
      }

      try {
        // JSON 배열 형태면 그대로 파싱
        let cands;
        if (raw.startsWith("[")) {
          cands = JSON.parse(raw);
        } else {
          // 줄 단위 JSON 객체들일 수도 있으니 각 줄 파싱 시도
          cands = raw.split("\n").map((line) => JSON.parse(line));
        }

        for (const c of cands) {
          await pc.addIceCandidate(c);
        }
        alert(`ICE 후보 ${cands.length}개 추가 완료`);
      } catch (e) {
        console.error(e);
        alert("ICE 후보 추가 실패: JSON 형식(배열/줄단위) 확인");
      }
    };

    $("btnConnectWS").onclick = async () => {
    roomId = $("roomId").value.trim();
    if (!roomId) { alert("roomId를 입력하세요"); return; }

    ws = new WebSocket(`ws://${location.hostname}:8080/ws`);
    console.log("[WS] connecting to", ws.url);

    ws.onopen = () => {
        console.log("[WS] open", ws.url);
        logStatus($("wsStatus"), "WS connected");
        wsSend("join", {});
    };

    ws.onclose = () => {
        console.log("[WS] close", ws.url);
        logStatus($("wsStatus"), "WS closed");
    };

    ws.onerror = () => {
        console.log("[WS] error", ws.url);
        logStatus($("wsStatus"), "WS error (서버 실행/주소 확인)");
    };

    ws.onmessage = async (evt) => {
        let msg;
        try {
          msg = JSON.parse(evt.data);
          console.log("[WS <-]", msg.type, "room=", msg.roomId, msg);
        } catch (e) {
          console.error("WS message JSON parse failed", e, evt.data);
          return;
        }

        if (!pc) return;

        if (msg.type === "offer") {
        // 상대 offer 받음 → remote 설정 → answer 만들고 보내기
        await pc.setRemoteDescription(msg.payload);
        await flushPendingCandidates();
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        wsSend("answer", pc.localDescription);

        } else if (msg.type === "answer") {
        // 상대 answer 받음 → remote 설정
        await pc.setRemoteDescription(msg.payload);
        await flushPendingCandidates();

        } else if (msg.type === "candidate") {
        // remoteDescription 설정 전에는 addIceCandidate가 InvalidStateError가 날 수 있으니 버퍼링
        if (pc.remoteDescription) {
          await pc.addIceCandidate(msg.payload);
        } else {
          pendingRemoteCandidates.push(msg.payload);
        }
        }
    };
    };

    //통화 시작 버튼
    $("btnStartCall").onclick = async () => {
      if (!pc) { alert("먼저 PC 만들기를 하세요"); return; }
      if (!ws || ws.readyState !== 1) { alert("먼저 WS 연결을 하세요"); return; }

      console.log("[CALL] start clicked. room=", roomId, "pcState=", pc.connectionState, "iceState=", pc.iceConnectionState);

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      console.log("[SDP] local offer set", pc.localDescription);
      wsSend("offer", pc.localDescription);
    };
  </script>
</body>
</html>